#!/bin/bash

#/*============================================================================
#
#  NifTK: A software platform for medical image computing.
#
#  Copyright (c) University College London (UCL). All rights reserved.
#
#  This software is distributed WITHOUT ANY WARRANTY; without even
#  the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
#  PURPOSE.
#
#  See LICENSE.txt in the top level directory for details.
#
#============================================================================*/

APP_SOURCE_DIR=@CMAKE_SOURCE_DIR@/Code/Applications
HELPER_APP_SOURCE_DIR=@CMAKE_SOURCE_DIR@/Code/Gui/MITK/HelperApps
BINARY_DIR=@EXECUTABLE_OUTPUT_PATH@
DOXYGEN_DIR=@CMAKE_BINARY_DIR@/Doxygen/CommandLine/
SUMMARY_FILE_APPS=${DOXYGEN_DIR}/CommandLineApplications.dox
SUMMARY_FILE_SCRIPTS=${DOXYGEN_DIR}/CommandLineScripts.dox
COPYRIGHT_TEXT="@NIFTK_COPYRIGHT@"
PLATFORM_TEXT="@NIFTK_PLATFORM@, @NIFTK_VERSION_STRING@"
WARNING_GENERATED="<b>(Note: This page is automatically generated. Please do not attempt to edit it!)</b>"

echo "Generating Doxygen for command line applications and scripts"
echo "  binary=${BINARY_DIR}"
echo "  doxygen=${DOXYGEN_DIR}"
echo "  copyright filter=${COPYRIGHT_TEXT}"
echo "  platform_filter=${PLATFORM_TEXT}"

if [ ! -d ${DOXYGEN_DIR} ]; then
  mkdir -p ${DOXYGEN_DIR}
fi

for f in Applications Scripts
do

  if [ "${f}" = "Applications" ]; then
    SUMMARY_FILE=${SUMMARY_FILE_APPS}
  else
    SUMMARY_FILE=${SUMMARY_FILE_SCRIPTS}
  fi
  
  echo "/**" > ${SUMMARY_FILE}
  echo "" >> ${SUMMARY_FILE}
  echo "\page UserManualCommandLine${f}Generated Command Line ${f}" >> ${SUMMARY_FILE}
  echo "" >> ${SUMMARY_FILE}
  echo "${WARNING_GENERATED}" >> ${SUMMARY_FILE}
  echo "" >> ${SUMMARY_FILE}
  echo "NifTK also contains a large array of command line ${f}. These are briefly listed in the table below. The left column links to a page describing the command line usage, and the right column is the first two lines from the usage message." >> ${SUMMARY_FILE}
  echo "" >> ${SUMMARY_FILE}
done

echo "\section UserManualCommandLineAppsCaveats Known Caveats" >> ${SUMMARY_FILE_APPS}
echo "" >> ${SUMMARY_FILE_APPS}
echo "\li Please read \link UnderstandingFileIO some background \endlink on file I/O in NifTK." >> ${SUMMARY_FILE_APPS}
echo "\li Most file read/write is based on file extensions, with each file reader/writer being implemented by different" >> ${SUMMARY_FILE_APPS}
echo "classes and hence different authors in ITK/MITK/NifTK. Thus users should be aware that there may be different behaviour for different file types. " >> ${SUMMARY_FILE_APPS}
echo "The only way to be sure is to test each application for your own file type of interest. " >> ${SUMMARY_FILE_APPS}
echo "\li Many ITK filters work on a "voxel by voxel" basis, such as adding, subtracting and multiplying images." >> ${SUMMARY_FILE_APPS} 
echo "By this we mean that image geometry such as origin, spacing, orientation etc. are not checked." >> ${SUMMARY_FILE_APPS}
echo "" >> ${SUMMARY_FILE_APPS}

PATH=${BINARY_DIR}:$PATH

for f in Applications Scripts
do
  if [ "${f}" = "Applications" ]; then
    SUMMARY_FILE=${SUMMARY_FILE_APPS}
  else
    SUMMARY_FILE=${SUMMARY_FILE_SCRIPTS}
  fi

  # Work out what files we are dealing with
  if [ "${f}" = "Applications" ]; then
    # Aim: Applications starting with niftk, not including the word TestDriver, not including stuff ending in .sh
    FILE_LIST=`cd ${BINARY_DIR} ; ls niftk* | grep -v TestDriver | egrep -v -e ".*[.]sh"`
  else
    # Aim: files ending in .sh, not containing the word batch, not starting with underscore
    FILE_LIST=`cd ${BINARY_DIR} ; ls *.sh | grep -v Batch | egrep -v -e "^[_].*"`
  fi
  
  echo "<table>" >> ${SUMMARY_FILE}

  CURRENT_DIRECTORY=${PWD}

  for g in ${FILE_LIST}
  do
    BASENAME=`basename ${g}`
    echo "Running file ${BASENAME}"
    
    # Aim:
    # The first colum in the table contains the executable name, linked to the Usage statement.
    # Each usage statement is made by running the application with zero arguments, and putting the output in a file.
    # The second column in the table contains a 2 line summary, from the top 2 lines of usage 
    # statement, filtering out NifTK copyright and version information.
    
    # First run the application with the -h switch.
     
    `cd ${BINARY_DIR} ; ${BASENAME} -h &> ${CURRENT_DIRECTORY}/doxygen.executable.txt`
    
    # Extract a summary file
    
    # If the program is a Slicer Command Line Module, with output generated by TCLAP
    # then we use different parsing rules. So, search for the presence of .xml file.
    if [ -e ${APP_SOURCE_DIR}/${BASENAME}.xml.in -o -e ${HELPER_APP_SOURCE_DIR}/${BASENAME}.xml.in ]; then
      DOXYGEN_SUMMARY=`${BINARY_DIR}/${BASENAME} --help | grep Description | cut -f 2-1000 -d : `
    else
      DOXYGEN_SUMMARY=`cat doxygen.executable.txt | gawk 'BEGIN {flgStop=0} /^Copyright/ {next} /^NifTK/ {next} /^Executing/ {next} /^$/ {next} /Usage/ {flgStop=1} {if (! flgStop) {print}}' | head -2`      
    fi
    
    # Generate a doxygen compatible page header
    
    echo "/**" > doxygen.header.txt
    echo "" >> doxygen.header.txt
    echo "\page ${BASENAME} ${BASENAME}" >> doxygen.header.txt
    echo "${WARNING_GENERATED}" >> doxygen.header.txt 
    echo "\verbatim" >> doxygen.header.txt
    
    # Generate a doxygen compatible page footer
    
    echo "\endverbatim" > doxygen.footer.txt
    echo "*/" >> doxygen.footer.txt
    
    # Stick it all together.
    
    cat doxygen.header.txt doxygen.executable.txt doxygen.footer.txt > ${DOXYGEN_DIR}/${BASENAME}.dox
  
    # Generate links in summary file  
    echo "<tr><td>\subpage ${BASENAME}</td><td>${DOXYGEN_SUMMARY}</td></tr>" >> ${SUMMARY_FILE}
  
  # End foreach file    
  done

  echo "</table>" >> ${SUMMARY_FILE}
  echo "" >> ${SUMMARY_FILE}
  echo "*/" >> ${SUMMARY_FILE}

# End foreach Applications Scripts
done



