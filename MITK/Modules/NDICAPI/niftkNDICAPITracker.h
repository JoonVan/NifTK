/*=============================================================================

  NifTK: A software platform for medical image computing.

  Copyright (c) University College London (UCL). All rights reserved.

  This software is distributed WITHOUT ANY WARRANTY; without even
  the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
  PURPOSE.

  See LICENSE.txt in the top level directory for details.

=============================================================================*/

/*=Plus=header=begin======================================================
The Plus license below is a BSD style license, with extensions
to cover contributions and other issues specific to Plus.

For more information, please see:
http://www.plustoolkit.org
______________________________________________________________

How to cite Plus:

Andras Lasso, Tamas Heffter, Adam Rankin, Csaba Pinter, Tamas Ungi, and Gabor Fichtinger, "PLUS: Open-source toolkit for ultrasound-guided intervention systems", IEEE Trans Biomed Eng. 2014 Oct;61(10):2527-37. doi: 10.1109/TBME.2014.2322864

@ARTICLE{Lasso2014a,
  title = {PLUS: Open-source toolkit for ultrasound-guided intervention systems},
  author = {Andras Lasso and Tamas Heffter and Adam Rankin and Csaba Pinter and Tamas Ungi and Gabor Fichtinger},
  journal = {IEEE Transactions on Biomedical Engineering},
  year = {2014},
  month = {Oct},
  number = {10},
  pages = {2527-2537},
  doi = {10.1109/TBME.2014.2322864},
  pmid = {24833412},
  url = {http://perk.cs.queensu.ca/contents/plus-open-source-toolkit-ultrasound-guided-intervention-systems}
}
______________________________________________________________

Plus Contribution and Software License Agreement ("Agreement")
Version 1.0 (October 24, 2011)

This Agreement covers contributions to and downloads from the Plus
project ("Plus") maintained by the Laboratory for Percutaneous
Surgery ("PerkLab"). Part A of this Agreement applies to
contributions of software and/or data to Plus (including making
revisions of or additions to code and/or data already in Plus). Part
B of this Agreement applies to downloads of software and/or data from
Plus. If you distribute Software (as defined below) downloaded from
Plus, all of the paragraphs of Part B of this Agreement must be
included with and apply to such Software.

Your contribution of software and/or data to Plus (including prior
to the date of the first publication of this Agreement, each a
"Contribution") and/or downloading, copying, modifying, displaying,
distributing or use of any software and/or data from Plus
(collectively, the "Software") constitutes acceptance of all of the
terms and conditions of this Agreement. If you do not agree to such
terms and conditions, you have no right to contribute your
Contribution, or to download, copy, modify, display, distribute or use
the Software.

PART A. CONTRIBUTION AGREEMENT - License to PerkLab with Right to
Sublicense ("Contribution Agreement").

1. As used in this Contribution Agreement, "you" means the individual
   contributing the Contribution to Plus and the institution or
   entity which employs or is otherwise affiliated with such
   individual in connection with such Contribution.

2. This Contribution Agreement applies to all Contributions made to
   Plus, including without limitation Contributions made prior to
   the date of first publication of this Agreement. If at any time you
   make a Contribution to Plus, you represent that (i) you are
   legally authorized and entitled to make such Contribution and to
   grant all licenses granted in this Contribution Agreement with
   respect to such Contribution; (ii) if your Contribution includes
   any patient data, all such data is de-identified in accordance with
   U.S. confidentiality and security laws and requirements, including
   but not limited to the Health Insurance Portability and
   Accountability Act (HIPAA) and its regulations, and your disclosure
   of such data for the purposes contemplated by this Agreement is
   properly authorized and in compliance with all applicable laws and
   regulations; and (iii) you have preserved in the Contribution all
   applicable attributions, copyright notices and licenses for any
   third party software or data included in the Contribution.

3. Except for the licenses granted in this Agreement, you reserve all
   right, title and interest in your Contribution.

4. You hereby grant to PerkLab, with the right to sublicense, a
   perpetual, worldwide, non-exclusive, no charge, royalty-free,
   irrevocable license to use, reproduce, make derivative works of,
   display and distribute the Contribution. If your Contribution is
   protected by patent, you hereby grant to PerkLab, with the right to
   sublicense, a perpetual, worldwide, non-exclusive, no-charge,
   royalty-free, irrevocable license under your interest in patent
   rights covering the Contribution, to make, have made, use, sell and
   otherwise transfer your Contribution, alone or in combination with
   any other code.

5. You acknowledge and agree that PerkLab may incorporate your
   Contribution into Plus and may make Plus available to members
   of the public on an open source basis under terms substantially in
   accordance with the Software License set forth in Part B of this
   Agreement. You further acknowledge and agree that PerkLab shall
   have no liability arising in connection with claims resulting from
   your breach of any of the terms of this Agreement.

6. YOU WARRANT THAT TO THE BEST OF YOUR KNOWLEDGE YOUR CONTRIBUTION
   DOES NOT CONTAIN ANY CODE THAT REQURES OR PRESCRIBES AN "OPEN
   SOURCE LICENSE" FOR DERIVATIVE WORKS (by way of non-limiting
   example, the GNU General Public License or other so-called
   "reciprocal" license that requires any derived work to be licensed
   under the GNU General Public License or other "open source
   license").

PART B. DOWNLOADING AGREEMENT - License from PerkLab with Right to
Sublicense ("Software License").

1. As used in this Software License, "you" means the individual
   downloading and/or using, reproducing, modifying, displaying and/or
   distributing the Software and the institution or entity which
   employs or is otherwise affiliated with such individual in
   connection therewith. The Laboratory for Percutanous Surgery
   ("PerkLab") hereby grants you, with right to sublicense, with
   respect to PerkLab's rights in the software, and data, if any,
   which is the subject of this Software License (collectively, the
   "Software"), a royalty-free, non-exclusive license to use,
   reproduce, make derivative works of, display and distribute the
   Software, provided that:

(a) you accept and adhere to all of the terms and conditions of this
Software License;

(b) in connection with any copy of or sublicense of all or any portion
of the Software, all of the terms and conditions in this Software
License shall appear in and shall apply to such copy and such
sublicense, including without limitation all source and executable
forms and on any user documentation, prefaced with the following
words: "All or portions of this licensed product (such portions are
the "Software") have been obtained under license from the Laboratory
for Percutaneous Surgery and are subject to the following terms and
conditions:"

(c) you preserve and maintain all applicable attributions, copyright
notices and licenses included in or applicable to the Software;

(d) modified versions of the Software must be clearly identified and
marked as such, and must not be misrepresented as being the original
Software; and

(e) you consider making, but are under no obligation to make, the
source code of any of your modifications to the Software freely
available to others on an open source basis.

2. The license granted in this Software License includes without
   limitation the right to (i) incorporate the Software into
   proprietary programs (subject to any restrictions applicable to
   such programs), (ii) add your own copyright statement to your
   modifications of the Software, and (iii) provide additional or
   different license terms and conditions in your sublicenses of
   modifications of the Software; provided that in each case your use,
   reproduction or distribution of such modifications otherwise
   complies with the conditions stated in this Software License.

3. This Software License does not grant any rights with respect to
   third party software, except those rights that PerkLab has been
   authorized by a third party to grant to you, and accordingly you
   are solely responsible for (i) obtaining any permissions from third
   parties that you need to use, reproduce, make derivative works of,
   display and distribute the Software, and (ii) informing your
   sublicensees, including without limitation your end-users, of their
   obligations to secure any such required permissions.

4. The Software has been designed for research purposes only and has
   not been reviewed or approved by the Food and Drug Administration
   or by any other agency. YOU ACKNOWLEDGE AND AGREE THAT CLINICAL
   APPLICATIONS ARE NEITHER RECOMMENDED NOR ADVISED. Any
   commercialization of the Software is at the sole risk of the party
   or parties engaged in such commercialization. You further agree to
   use, reproduce, make derivative works of, display and distribute
   the Software in compliance with all applicable governmental laws,
   regulations and orders, including without limitation those relating
   to export and import control.

5. The Software is provided "AS IS" and neither PerkLab nor any
   contributor to the software (each a "Contributor") shall have any
   obligation to provide maintenance, support, updates, enhancements
   or modifications thereto. PERKLAB AND ALL CONTRIBUTORS SPECIFICALLY
   DISCLAIM ALL EXPRESS AND IMPLIED WARRANTIES OF ANY KIND INCLUDING,
   BUT NOT LIMITED TO, ANY WARRANTIES OF MERCHANTABILITY, FITNESS FOR
   A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL
   PERKLAB OR ANY CONTRIBUTOR BE LIABLE TO ANY PARTY FOR DIRECT,
   INDIRECT, SPECIAL, INCIDENTAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES
   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY ARISING IN ANY WAY
   RELATED TO THE SOFTWARE, EVEN IF PERKLAB OR ANY CONTRIBUTOR HAS
   BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES. TO THE MAXIMUM
   EXTENT NOT PROHIBITED BY LAW OR REGULATION, YOU FURTHER ASSUME ALL
   LIABILITY FOR YOUR USE, REPRODUCTION, MAKING OF DERIVATIVE WORKS,
   DISPLAY, LICENSE OR DISTRIBUTION OF THE SOFTWARE AND AGREE TO
   INDEMNIFY AND HOLD HARMLESS PERKLAB AND ALL CONTRIBUTORS FROM AND
   AGAINST ANY AND ALL CLAIMS, SUITS, ACTIONS, DEMANDS AND JUDGMENTS
   ARISING THEREFROM.

6. None of the names, logos or trademarks of PerkLab or any of
   PerkLab's affiliates or any of the Contributors, or any funding
   agency, may be used to endorse or promote products produced in
   whole or in part by operation of the Software or derived from or
   based on the Software without specific prior written permission
   from the applicable party.

7. Any use, reproduction or distribution of the Software which is not
   in accordance with this Software License shall automatically revoke
   all rights granted to you under this Software License and render
   Paragraphs 1 and 2 of this Software License null and void.

8. This Software License does not grant any rights in or to any
   intellectual property owned by PerkLab or any Contributor except
   those rights expressly granted hereunder.
=========================================================Plus=header=end*/

/*=========================================================================
The following copyright notice is applicable to parts of this file:

Copyright (c) 2000-2005 Atamai, Inc.

Use, modification and redistribution of the software, in source or
binary forms, are permitted provided that the following terms and
conditions are met:

1) Redistribution of the source code, in verbatim or modified
   form, must retain the above copyright notice, this license,
   the following disclaimer, and any notices that refer to this
   license and/or the following disclaimer.

2) Redistribution in binary form must include the above copyright
   notice, a copy of this license and the following disclaimer
   in the documentation or with other materials provided with the
   distribution.

3) Modified copies of the source code must be clearly marked as such,
   and must not be misrepresented as verbatim copies of the source code.

THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES PROVIDE THE SOFTWARE "AS IS"
WITHOUT EXPRESSED OR IMPLIED WARRANTY INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE.  IN NO EVENT SHALL ANY COPYRIGHT HOLDER OR OTHER PARTY WHO MAY
ODIFY AND/OR REDISTRIBUTE THE SOFTWARE UNDER THE TERMS OF THIS LICENSE
BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, LOSS OF DATA OR DATA BECOMING INACCURATE
OR LOSS OF PROFIT OR BUSINESS INTERRUPTION) ARISING IN ANY WAY OUT OF
THE USE OR INABILITY TO USE THE SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.

=========================================================================*/

#ifndef niftkNDICAPITracker_h
#define niftkNDICAPITracker_h

#include "niftkNDICAPIExports.h"
#include <cstring>
#include <string>
#include <map>
#include <vector>

struct ndicapi;

namespace niftk {

// the number of tools the polaris can handle
#define VTK_NDI_REPLY_LEN 2048

/*!
  \class NDICAPITracker
  \brief Interface class for Northern Digital's tracking devices

  The NDICAPITracker class provides an  interface to the AURORA and POLARIS
  (Northern Digital Inc., Waterloo, Canada) using the new "combined API" and
  should also support all newer NDI tracking devices.  Any POLARIS systems
  purchased before 2002 will not support the combined API.

  For active (wired) tools specify PortName attribute. For example,
  PortName="0" is the first port, PortName="1" is the second, etc.

  If multi-channel tools are used then the PortName is <ChannelNumber><PortNumber>,
  for example for two 5-DOF sensors plugged into the first connector:
  PortName="0" and PortName="100", for two 5-DOF sensors plugged into the second connector:
  PortName="1" and PortName="101".

  For passive (wireless) tools specify RomFile attribute. For example,
  RomFile="NdiToolDefinitions/8700339.rom".

  Important notes on the data collection rate of the Polaris:

  The camera frame rate is 60Hz, and therefore the maximum data
  collection rate is also 60Hz.  The maximum data transfer rate
  to the computer is also 60Hz.

  Depending on the number of enabled tools, the data collection
  rate might be reduced.  Each of the active tools requires one
  camera frame, and all the passive tools (if any are enabled)
  collectively require one camera frame.

  Therefore if there are two enabled active tools, the data rate
  is reduced to 30Hz.  Ditto for an active tool and a passive tool.
  If all tools are passive, the data rate is 60Hz.  With 3 active
  tools and one or more passive tools, the data rate is 15Hz.
  With 3 active tools, or 2 active and one or more passive tools,
  the data rate is 20Hz.

  The data transfer rate to the computer is independent of the data
  collection rate, and there might be duplicated records.  The
  data tranfer rate is limited by the speed of the serial port
  and by the number of characters sent per data record.  If tools
  are marked as 'missing' then the number of characters that
  are sent will be reduced.
*/
class NIFTKNDICAPI_EXPORT NDICAPITracker
{
public:

  NDICAPITracker();
  ~NDICAPITracker();

  enum PlusStatus
  {
    PLUS_FAIL=0,
    PLUS_SUCCESS=1
  };

  /*! Flags for tool LEDs */
  enum LedState
  {
    TR_LED_OFF   = 0,
    TR_LED_ON    = 1,
    TR_LED_FLASH = 2
  };

  virtual bool IsTracker() const { return true; }

  /*! Hardware device SDK version. */
  virtual std::string GetSdkVersion();

  /*!
    Probe to see if the tracking system is present on the
    specified serial port.  If the SerialPort is set to -1,
    then all serial ports will be checked.
  */
  PlusStatus Probe();

  /*!
    Send a command to the NDI in the format INIT: or VER:0 (the
    command should include a colon).  Commands can only be done after
    either Probe() or StartTracking() has been called.
    The text reply from the NDI is returned, without the CRC or
    final carriage return.
  */
  char *Command(const char *command);

  /*!
    Get the a string (perhaps a long one) describing the type and version
    of the device.
  */
  char* GetVersion() const { return this->Version; }

  /*! Set which serial port to use, 1 through 4 */
  void SetSerialPort(int i) { this->SerialPort = i; }
  int GetSerialPort() const { return this->SerialPort; }

  /*! Set the desired baud rate.  Default: 9600. */
  void SetBaudRate(int i) { this->BaudRate = i; }
  int GetBaudRate() const { return this->BaudRate; }

  /*!
    Measurement volume number. It can be used for defining volume type (dome, cube) and size.
    Default is 0, which means that the default volume is used.
    First valid volume number is 1.
    If an invalid value is set (for example -1) then a list of available volumes is logged.
    See VSEL command in the NDI API documentation for details.
  */
  void SetMeasurementVolumeNumber(int i) { this->MeasurementVolumeNumber = i; }
  int GetMeasurementVolumeNumber() const { return this->MeasurementVolumeNumber; }

  /*!
    Get an update from the tracking system and push the new transforms
    to the tools.  This should only be used within vtkTracker.cxx.
  */
  PlusStatus InternalUpdate();
  std::map<std::string, std::vector<double> > GetTrackerQuaternions();

  /*! Read NDI tracker configuration from xml data */
  // NifTK commented out: virtual PlusStatus ReadConfiguration(vtkXMLDataElement* config);
  // (because PLUS reads config from an .xml file).

  /*! Read NDI tracker configuration from xml data */
  // NifTK commented out: virtual PlusStatus WriteConfiguration(vtkXMLDataElement* config);
  // (because PLUS reads config from an .xml file).

  /*! Set the specified tool LED to the specified state */
  PlusStatus SetToolLED(const char* portName, int led, LedState state);

// NifTK commented out: protected:
public:

  struct NdiToolDescriptor
  {
    int WiredPortNumber; // >=0 for wired tools
    unsigned char *VirtualSROM; // nonzero for wireless tools
    bool PortEnabled; // true if the tool is successfully enabled in the tracker
    int PortHandle; // this number identifies the tool in the tracker
  };

  /*! Set the version information */
  void SetVersion (const char* v)
  {
    if (this->Version && v && (!strcmp(this->Version,v))) { return; }
    if (this->Version) { delete [] this->Version; }
    if (v)
    {
      this->Version = new char[strlen(v)+1];
      strcpy(this->Version, v);
    }
    else
    {
      this->Version = nullptr;
    }
  }

  /*! Connect to the tracker hardware */
  PlusStatus InternalConnect();

  /*! Disconnect from the tracker hardware */
  PlusStatus InternalDisconnect();

  /*!
    Start the tracking system.  The tracking system is brought from
    its ground state into full tracking mode.  The device will
    only be reset if communication cannot be established without
    a reset.
  */
  PlusStatus InternalStartRecording();

  /*!
    Stop the tracking system and bring it back to its ground state:
    Initialized, not tracking, at 9600 Baud.
  */
  PlusStatus InternalStopRecording();

  /*! Cause the device to beep the specified number of times */
  PlusStatus Beep(int n);

  /*! Read a virtual SROM from file and store it in the tool descriptor */
  PlusStatus ReadSromFromFile(NdiToolDescriptor& toolDescriptor, const char *filename);

  /*!
    Sets the port handle in the descriptor. For wired tools it
    iterates through the existing connections, for wireless tools
    it requests a new handle.
  */
  PlusStatus UpdatePortHandle(NdiToolDescriptor& toolDescriptor);

  /*!
    This is a low-level method for loading a virtual SROM.
    You must halt the tracking thread and take the device
    out of tracking mode before you use it.
    This call also sets the port handle in the descriptor.
  */
  PlusStatus SendSromToTracker(const NdiToolDescriptor& toolDescriptor);

  /*!
    This is a low-level method for loading a virtual SROM.
    You must halt the tracking thread and take the device
    out of tracking mode before you use it.
  */
  PlusStatus ClearVirtualSromInTracker(NdiToolDescriptor& toolDescriptor);

  /*!
    Methods for detecting which ports have tools in them, and
    auto-enabling those tools.
  */
  PlusStatus EnableToolPorts();

  /*!
    Methods for detecting which ports have tools in them, and
    auto-enabling those tools.
  */
  void DisableToolPorts();

  /*! Parse and log available volume list response */
  // NifTK commented out: void LogVolumeList(const char* ndiVolumeListCommandReply, int selectedVolume, vtkPlusLogger::LogLevelType logLevel);
  // (just so I can use std::cerr/std::cout logging, which is basic... )
  void LogVolumeList(const char* ndiVolumeListCommandReply, int selectedVolume);

  /*! Index of the last frame number. This is used for providing a frame number when the tracker doesn't return any transform */
  unsigned long LastFrameNumber;

  ndicapi *Device;
  char *Version;
  char *SerialDevice;

  int SerialPort;
  int BaudRate;
  int IsDeviceTracking;

  int MeasurementVolumeNumber;

  typedef std::map<std::string, NdiToolDescriptor> NdiToolDescriptorsType;

  /*! Maps Plus tool source IDs to NDI tool descriptors */
  NdiToolDescriptorsType NdiToolDescriptors;

  char CommandReply[VTK_NDI_REPLY_LEN];

private:

  NDICAPITracker(const NDICAPITracker&); /* Purposefully not implemented. */
  void operator=(const NDICAPITracker&); /* Purposefully not implemented. */

  std::map<std::string, std::vector<double> > m_TrackerQuaternions;

  unsigned int m_SuppressUpateErrorsAfterNRepeats;  // To stop repeated calls to internal update flooding the console.
  unsigned int m_UpdateErrorRepeatCounter;          // To stop repeated calls to internal update flooding the console.
};

} // end namespace

#endif
