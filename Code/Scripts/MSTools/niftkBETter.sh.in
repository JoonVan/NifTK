#!/bin/bash 

#/*=============================================================================
#
# NifTK: An image processing toolkit jointly developed by the
#             Dementia Research Centre, and the Centre For Medical Image Computing
#             at University College London.
# 
# See:        http://dementia.ion.ucl.ac.uk/
#             http://cmic.cs.ucl.ac.uk/
#             http://www.ucl.ac.uk/
#
# Last Changed      : $Date: 2012-10-17 14:43:44 +0000 (Wed, 17 Oct 2012) $
# Revision          : $Revision: 1 $
# Last modified by  : $Author: fp $
#
# Original author   : f.carrasco@ucl.ac.uk
#
# Copyright (c) UCL : See LICENSE.txt in the top level directory for details.
#
# This software is distributed WITHOUT ANY WARRANTY; without even
# the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
# PURPOSE.  See the above copyright notices for more information.
#
# ============================================================================*/
#
# This script is for BET mask calculation using Pospescu et al. Neuroimage 2012 
# brain extraction process and Boyes et al. Neuroimage 2008 normalization process. 
#
# The basic method is:
# If the user runs niftkBETter.sh --xml we respond with the XML function contained herein.
# All other command line invocations, we pass the parameters onto the underlying program.

source _niftkCommon.sh

###### DEFAULT OPTIONS #######

# This options for n3 has been extracted from Boyes et al. Neuroimage 2008 page 1756
n3_options='-clobber -stop 0.000100 -fwhm 0.050000 -distance 150 -iterations 1000 -shrink 2'
dir_output='noneck/'
unalias rm 2> /dev/null # don't ask about removing existing files

# Directory configurations for change the default
dir_niftyreg=""
mnidir=""
n3dir=""

# Function  : Clean temp directory 
#
function cleanup
{
	if [[ -d ../${dir_output} ]] ; then
		cd ..
	fi
	if [[ -d ${dir_output} ]] ; then
		if ! ${debug_mode} ; then
			rm -rf ${dir_output} 
		fi
	fi
}
trap "cleanup" EXIT SIGINT SIGTERM SIGKILL


# Function  : Data normalization
#
# Param	    : $1 input image 
# Param     : $2 patient name
# Param	    : $3 volume orientation
function normalization() 
{
	local img=$1
	local name=$2
	local orientation=$3
	
	# Normalization
	if [[ ! -f "${img}_n3.nii.gz"  ]] ; then
		# Delete temporally files
		execute_command_or_else_stop "rm -f *.mnc ${img}_n3*"
		execute_command_or_else_stop "rm -f ${img}_ICBM152_mask_register*" 
		
		# Move tissues mask to target space
		execute_command_or_else_stop "${dir_niftyreg}reg_resample \
			-ref ${img}.nii.gz \
			-flo ${MASK_IMAGE} \
			-aff source-to-target-12dof.txt \
			-res ${img}_ICBM152_mask_register.nii.gz \
			-NN"
		
		# Set tissues mask from float to char
		execute_command_or_else_stop "fslmaths \
			${img}_ICBM152_mask_register.nii.gz \
			-bin \
			${img}_ICBM152_mask_register-bin.nii.gz \
			-odt char"

		# Change format to NIFTI
		execute_command_or_else_stop "rm -f ${img}_ICBM152_mask_register.nii.gz"
		execute_command_or_else_stop "fslchfiletype NIFTI ${img}_ICBM152_mask_register-bin ${img}_ICBM152_mask_register.nii"
		execute_command_or_else_stop "rm -f ${img}_ICBM152_mask_register-bin.*"
		execute_command_or_else_stop "fslchfiletype NIFTI ${img}.nii.gz ${img}_2.nii"  

		# Change format to mnc
		execute_command_or_else_stop "${mnidir}nii2mnc $orientation ${img}_2.nii ${img}.mnc"
		execute_command_or_else_stop "${mnidir}nii2mnc $orientation ${img}_ICBM152_mask_register.nii ${img}_ICBM152_mask_register.mnc"
		progressXML "0.30" "Image ready to be normalized"
		
		# This options for n3 has been extracted from Boyes et al. Neuroimage 2008 page 1756
		if [[ ! -f "${img}_n3.mnc"  ]] ; then		
			execute_command_or_else_stop "${n3dir}nu_correct $n3_options \
			-mask ${img}_ICBM152_mask_register.mnc \
			${img}.mnc \
			${img}_n3.mnc" > /dev/null
		fi		
		progressXML "0.45" "Image normalized"

		# Change format from mnc to NIFTI
		execute_command_or_else_stop "${mnidir}mnc2nii -nii ${img}_n3.mnc ${img}_n3_temp.nii"
		execute_command_or_else_stop "fslchfiletype NIFTI_GZ ${img}_n3_temp.nii ${img}_n3.nii.gz"
		execute_command_or_else_stop "rm -f ${img}_n3_nifti.nii *.mnc"
	else
		echo "File ${img}_n3.nii.gz exists, we don't repeat the calculation "
	fi
}

# Function  : This function remove neck from a T1 brain data
#
# Param	    : $1 input image
# Param     : $2 patient name
function remove_neck() {
	local img=$1
	local name=$2
	
	if [[ ! -f "${img}_no_neck.nii.gz"  ]] ; then
		progressXML "0.1" "Registering atlas"
		
		# Register atlas to target space
		execute_command_or_else_stop "${dir_niftyreg}reg_aladin \
			-ref ${img}.nii.gz \
			-flo ${HEAD_IMAGE} \
			-aff source-to-target-12dof.txt \
			-res ${img}_neck_register.nii.gz \
			-sym \
			-lp 5" 
		progressXML "0.15" "Atlas registered"
			
		# Move whole headmask to target space			
		execute_command_or_else_stop "${dir_niftyreg}reg_resample \
			-ref ${img}.nii.gz \
			-flo ${HEADMASK_IMAGE} \
			-aff source-to-target-12dof.txt \
			-res ${img}_ICBM152_mask_register.nii.gz \
			-NN"
			
		# Remove neck of input image	
		execute_command_or_else_stop "${dir_niftyreg}reg_tools \
			-in ${img}.nii.gz \
			-nan ${img}_ICBM152_mask_register.nii.gz \
			-out ${img}_no_neck.nii.gz"

		# Convert nan to 0, if not, BET crashes
		execute_command_or_else_stop "fslmaths ${img}_no_neck.nii.gz -nan ${img}_no_neck-nonan.nii.gz"
		execute_command_or_else_stop "cp ${img}_no_neck-nonan.nii.gz ${img}_no_neck.nii.gz"

	else
		echo "File ${img}_no_neck.nii.gz exists, we don't repeat the calculation "
	fi
}

# Function  : Calculating brain mask following Pospescu 2012 Neuroimage 
#
# Param	    : $1 input image
# Param	    : $2 output image
# Param     : $3 patient name
# Param     : $4 options for BET
# Param     : $5 fractional intensity threshold
# Param	    : $6 volume orientation
# Param	    : $7 apply normalization
function BETter() 
{
	local img=$1
	local output_result=$2
	local name=$3
	local opt=$4
	local frac=$5
	local orientation=$6
	local norm=$7
	local output_type=$8
	local suffix=""
	
	# Starting brain extraction process
	if [[ ! -f "${output_result}"  ]] ; then
		# First remove neck slices according to Popescu 2012 method
		remove_neck ${img} ${name}
		progressXML "0.2" "Neck removed"

		if [ ${norm} = true ] ; then
			# Normalize intesity for image following from Boyes et al. Neuroimage 2008 page 1756
			normalization ${img}_no_neck ${name} ${orientation}
			suffix="_no_neck_n3"
		else
			suffix="_no_neck"
		fi

		progressXML "0.6" "Calculating brain extraction: bet ${opt} -f ${frac}"
		
		# Pospescu 2012 Neuroimage article suggests that best parameters could be -B -f 0.1, previously neck removal
		if [[ ! -f "${img}_brain.nii.gz"  ]] ; then
			execute_command_or_else_stop "bet ${img}${suffix} ${img}_brain -m -s ${opt} -f ${frac}" 
		else
			echo "File "${img}_brain.nii.gz" exists, we don't repeat the calculation "
		fi
	
		progressXML "0.9" "Copying results"
		
		dir_file=`dirname ${output_result}`
		if [ "${dir_file}" == "." ] ; then
			dir_result="../"
		else
			dir_result="${dir_file}/"
		fi

		# Copy all the results
		name_file=`basename ${output_result}`
		name=${name_file%%.*};
		extension=${name_file#*.};
		copyFileToDestination "${img}_brain.nii.gz" "${dir_result}${name}.${extension}"
		copyFileToDestination "${img}_brain_mask.nii.gz" "${dir_result}${name}_mask.${extension}"
		copyFileToDestination "${img}_brain_skull.nii.gz" "${dir_result}${name}_skull.${extension}"
		
	else
		echo "File ${output_result} exists, we don't repeat the calculation "
	fi
	
}

# Function  : If the user runs niftkBETter.sh --xml we respond with the XML function contained herein.
#
function UsageXML() {
cat <<EOF
<?xml version="1.0" encoding="utf-8"?>
<executable>
   <category>MS Tools.Segmentation</category>
   <title>BET Brain segmentation improved</title>
   <description><![CDATA[This script, provided within @NIFTK_PLATFORM@, is for BET mask calculation using Pospescu et al. Neuroimage 2012 
   brain extraction process.<br>
   <ul>
   <li><i>Input image</i>, selects the file that you would like to segment</li>
   <li><i>Input atlas data</i>, selects the ATLAS data file, ex: ICBM-152/lin-1.0/icbm_avg_152_t1_tal_lin.nii, you need to be careful that it exists overlapping between this image and input image.</li>
   <li><i>Input headmask atlas data</i>, selects the ATLAS headmask data file, ex: ICBM-152/lin-1.0/icbm_avg_152_t1_tal_lin_headmask.nii</li>
   <li><i>Input mask atlas data</i>, selects the ATLAS mask data file, ex: ICBM-152/lin-1.0/icbm_avg_152_t1_tal_lin_mask.nii</li>
   <li><i>Output image</i>, select the name and the directory of the output file where the segmented image will be recorded. The output file is composed for three files:
	<ul>
	<li><i>output</i>, it contains the segmented brain</li>
	<li><i>output_mask</i>, it correponds to the brain mask of the segmented brain</li>
	<li><i>output_skull</i>, it correponds to the brain skull of the segmented brain</li>
	</ul>
   </li>
   </ul>
   <br>
   <p><h2>Recomendations:</h2></p>
   <p>
   For ADNI data swaps dimensions x y z to -y -z x and removes s form information of ICBM 152
   atlas head maks, mask and data files. For other data sources you would need to check it.
   Check that it exists an important overlapping between mask, headmask, head and input file.<br>
   </p>
   ]]></description>
   <version>12.11</version>
   <documentation-url>http://www.sciencedirect.com/science/article/pii/S1053811912003552</documentation-url>
   <license>BSD</license>
   <contributor>Ferran Prados (UCL)</contributor>
   <parameters advanced="false">
      <label>Mandatory arguments</label>
      <description>Input image to be segmented and the name of output image</description>
      <image fileExtensions="*.nii,*.nii.gz,*.img">
          <name>inputImageName</name>
          <longflag>in</longflag>
	  <description>Input image name</description>
	  <label>Input image</label>
	  <channel>input</channel>
      </image>
      <image fileExtensions="*.nii,*.nii.gz,*.img">
          <name>inputHead</name>
          <longflag>atlas</longflag>
	  <description>Input atlas data</description>
	  <label>Input atlas data</label>
	  <channel>input</channel>
      </image>
      <image fileExtensions="*.nii,*.nii.gz,*.img">
          <name>inputIHeadMask</name>
          <longflag>headmask</longflag>
	  <description>Input atlas head mask</description>
	  <label>Input atlas head mask</label>
	  <channel>input</channel>
      </image>
      <image fileExtensions="*.nii,*.nii.gz,*.img">
          <name>inputMask</name>
          <longflag>mask</longflag>
	  <description>Input atlas mask</description>
	  <label>Input atlas mask</label>
	  <channel>input</channel>
      </image>
      <image fileExtensions="*.nii,*.nii.gz,*.img">
          <name>outputImageName</name>
          <longflag>out</longflag>
	  <description>Output image name</description>
	  <label>Output image</label>
	  <default>output.nii.gz</default>
          <channel>output</channel>
      </image>
   </parameters>
   <parameters advanced="true">
    <label>Variations on default BET functionality</label>
    <description>BET options</description>
    <string-enumeration>
      <name>BEToptions</name>
      <longflag>bet</longflag>
      <description><![CDATA[Variations on default BET functionality: 
      B - bias field & neck cleanup, 
      S - eye & optic nerve cleanup, 
      R - robust brain centre estimation and 
      Z - improve BET if FOV is very small in Z]]></description>
      <label>BET options</label>
      <default>B</default>
      <element>B</element>
      <element>S</element>
      <element>R</element>
      <element>Z</element>
    </string-enumeration>
    <float>
      <name>FractionalIntensityThreshold</name>
      <longflag>f</longflag>
      <description><![CDATA[Fractional intensity threshold (0-1); 
      default=0.1 for Pospescu et al. 2012 paper. 
      In BET, 0.5 is the default value. 
      Lower values than default give larger brain outlines; 
      higher values lead to smaller brain outlines.]]></description>
      <label>Fractional intensity threshold</label>
      <default>0.1</default>
      <constraints>
        <minimum>0</minimum>
        <maximum>1</maximum>
        <step>0.1</step>
      </constraints>
    </float>
    <boolean>
      <name>normalize</name>
      <longflag>norm</longflag>      
      <description>Apply Boyes et al. Neuroimage 2008 normalization process</description>
      <label>Normalization (N3)</label>
    </boolean>
    <string-enumeration>
      <name>orientation</name>
      <longflag>orient</longflag>
      <description><![CDATA[Input images are in:
      A - Axial orientation 
      C - Coronal orientation 
      S - Sagittal orientation]]></description>
      <label>Input image orientation</label>
      <default>A</default>
      <element>A</element>
      <element>C</element>
      <element>S</element>
    </string-enumeration>
    <boolean>
          <name>debugMode</name>
          <longflag>debug</longflag>      
          <description>Debug mode doesn't delete temporary intermediate images</description>
          <label>Debug mode</label>
      </boolean>
      <boolean>
          <name>same</name>
          <longflag>same</longflag>      
          <description>Always use the same temp directory for computing (this option is useful mixed with -debug)</description>
          <label>Temp directory</label>
      </boolean>
    </parameters>
</executable>
EOF
exit 0
}

# Function  : If the user runs niftkBETter.sh -h, --help or without parameters we respond with the Usage function contained herein.
#
function Usage() {
cat <<EOF

This script is for BET mask calculation using Pospescu et al. Neuroimage 2012 brain extraction process. 

Usage: $0 -in input_file -out output_file -headmask head_mask_file -mask mask_file -atlas head_file

Mandatory Arguments:
 
  -in			: is the input file 
  -out			: is the output file 
  -headmask		: is the headmask atlas file (ex: ICBM-152/lin-1.0/icbm_avg_152_t1_tal_lin_headmask.nii)
  -mask			: is the mask atlas file (ex: ICBM-152/lin-1.0/icbm_avg_152_t1_tal_lin_mask.nii)
  -atlas		: is the atlas data file (ex: ICBM-152/lin-1.0/icbm_avg_152_t1_tal_lin.nii)
  
Optional Arguments:   
  -bet			: variations on default BET functionality: B, S, R or Z. (see BET for more information), by default B
  -f			: fractional intensity threshold (0->1); by default 0.1.
  -norm			: apply Boyes et al. Neuroimage 2008 normalization process.
  -orient <value>	: input images are in AXIAL (a), CORONAL (c) or SAGITTAL (s) orientation, it is needed for the normalization step
  -debug		: debug mode doesn't delete temporary intermediate images
  -same			: Always use the same temp directory for computing (this option is useful mixed with -debug)
  
Recomendations:

	For ADNI data swaps dimensions x y z to -y -z x and removes s form information of ICBM 152 
	Atlas head maks, mask and data files. For other data sources you would need to check it.
	Check that it exists an important overlapping between mask, headmask, head and input file.
	
EOF
exit 127
}


# Program start
export FSLOUTPUTTYPE=NIFTI_GZ
f="0.1"
options="-B"
orientation=""
norm=false
debug_mode=false
same=false
if [ $# -eq 0 ]; then
  Usage
fi

# Parse remaining command line options
while [ "$#" -gt 0 ]
do
    case $1 in
    -xml | --xml) UsageXML
	;; 
    -h | --help)
	Usage
	;;
    --in | -in )
	INPUT_IMAGE=$2
	shift 1
	;;
    --out | -out )
	OUTPUT_IMAGE=$2
	shift 1
	;;
    --headmask | -headmask )
	HEADMASK_IMAGE=$2
	shift 1
	;;
    --mask | -mask )
	MASK_IMAGE=$2
	shift 1
	;;
    --atlas | -atlas )
	HEAD_IMAGE=$2
	shift 1
	;;
    --bet | -bet )
	options="-$2"
	shift 1
	;;
    --f | -f)
	f="$2"
	shift 1
	;;
    --orient | -orient)
	case $2 in
		a | A) orientation="-transverse"
		;;
		c | C) orientation="-coronal"
		;;
		s | S) orientation="-sagittal"
		;;
	esac
	shift 1
	;;
    --norm | -norm)
	norm=true
	;;
    --debug | -debug)
	debug_mode=true
	;;
    --same | -same)
	same=true
	;;
    -*)
	Usage
	exitprog "Error: option $1 not recognised" 1
	 ;;
    esac
    shift 1
done

if [ ${norm} = true ] ; then
	if [[ -z ${orientation} ]] ; then
		exitprog "Failed, specify an orientation is needed (orientation=${orientation})" 1
	fi
fi

# Start of the main program
openprogressXML "BETter Starts with options: ${options} -f ${f}"
progressXML "0.04" "Checking programs"

# Check that all programs exist
check_program_exists fslcpgeom
check_program_exists fslchfiletype
check_program_exists bet
check_program_exists fslmaths
check_program_exists reg_aladin
check_program_exists reg_resample
check_program_exists reg_tools
check_program_exists nii2mnc
check_program_exists mnc2nii
check_program_exists nu_correct

progressXML "0.08" "Checking input and output file"
if [[ -z ${OUTPUT_IMAGE} ]] ; then
	progressXML "0.08" "Failed, specify an output filename is needed (output image=${OUTPUT_IMAGE})"
	exitprog "Failed, specify an output filename is needed (output image=${OUTPUT_IMAGE})" 1
fi
if [[ -d ${OUTPUT_IMAGE} ]] ; then
	progressXML "0.08" "${OUTPUT_IMAGE} is not a file, select a file"
	exitprog "${OUTPUT_IMAGE} is not a file, select a file" 1
fi
if ( ls ${OUTPUT_IMAGE/%\.*/}* > /dev/null ) then
	progressXML "0.08" "There are files with the same name of the output file (${OUTPUT_IMAGE}) in the output directory. It could be a source of conflicts. Please, change the name, or remove the files."
	exitprog "There are files with the same name of the output file (${OUTPUT_IMAGE}) in the output directory. It could be a source of conflicts. Please, change the name, or remove the files." 1
fi

# Check if all needed files exist
check_file_exists ${INPUT_IMAGE} 
check_file_exists ${HEAD_IMAGE}
check_file_exists ${MASK_IMAGE}
check_file_exists ${HEADMASK_IMAGE}

# Get specific information
if [ ${same} = true ] ; then
	patient='nifTK'
else
	patient='nifTK_'`date +"%Y%m%d-%H%M%S"`
fi
dir_output=${patient}-${dir_output}

# Create an output directory and copy data
if [[ ! -d $dir_output ]] ; then
	execute_command_or_else_stop "mkdir -p ${dir_output}"
fi
copyFileToDestination ${INPUT_IMAGE} "${dir_output}input_image.nii.gz" 

# Go to the output directory
execute_command_or_else_stop "cd ${dir_output}"

# Start process
BETter "input_image" "${OUTPUT_IMAGE}" "${patient}" "${options}" "${f}" "${orientation}" "${norm}" "${OUTPUT_TYPE}"

progressXML "1" "Finish"
closeprogressXML ${OUTPUT_IMAGE}
# End of the main program
